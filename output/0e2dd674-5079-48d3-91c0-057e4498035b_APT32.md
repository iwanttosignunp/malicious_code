
## Unknown Title  

## 返回TI主页  

RESEARCH  

数据驱动安全  

## 概述  

新海莲花组织最早出现于2022年中，直到2023年底转入不活跃状态，2024年11月重新活跃并被我们快速制止披露[1]，在2023年全年新海莲花组织展示出于以往完全不同的技战术，进攻水平也比之前提升很多，使用多个0day漏洞针对我国军工、能源、航空等领域开展间谍活动，意图窃取我国能源和军工领域在中东、中亚、非洲、东亚的部署情况。  

本文仅作为安全研究，我们不关注初始样本载荷，主要披露新海莲花组织内存插件和间谍目的，天擎EDR可以在内存中精准告警新海莲花组织所有内存插件，我们建议政企客户启用云查功能来发现未知威胁。  

## 奇安信天擎提醒|内存攻击防护发现程序正在执行可疑内存代码，建议阻止  

可疑程序：自C:\Users\Adminis...llCodeLoader.exe可疑来源：C:\Windows\System32\cmd.exe  

内存攻击是指利用Shellcode执行恶意代码  

![](images/0_0.jpg)
  

不再提醒  

允许  

立即阻止(20)  

## 内存技战术

<--- Page Split --->

新海莲花组织通过终端软件0day漏洞向内网特定终端下发恶意更新，实现供应链攻击，在目前国内错综复杂的安全产品生态下这种攻击模式是所有APT组织的最优解，并不是海莲花组织独有的手法[2]，我们甚至观察到针对国内的勒索软件运营商也有类似的操作，区别在于勒索运营商会向全内网终端下发勒索软件，而APT组织则是选择特定的目标终端后下发，新海莲花组织内存技战术如下：  

![](images/1_0.jpg)
  

新海莲花组织在2022- 2023年所使用的CobaltStrike有一个非常明显的特征：  

木马运行后会自动将当前的屏幕截图保存为PNG格式并发送到C2服务器上，如果恰好此时攻击者正处于RDP的状态，那么就能在受害者机器上得到一张攻击者双击木马程序的照片：  

![](images/1_1.jpg)
  

Cobalt Strike注入到系统进程后会在当前进程中内存加载Rust特马并回连新的C2，Rust特马的分析友商已经有过分析，故不再赘述。接着通过ProcessHollowing的方式将文件目录收集插件注入到系统进程中。

<--- Page Split --->

v9 = v24(v54, 0x80000000164, 1i64, 0i64, 3, 128, 0i64); // CreateFileW // L"C:\\Users\\ADMINI- 1\\AppData\\Local\\Temp\\5fff4bed- 85ea- 4ba1- 8795- v10 = v27(v9, 0i64); // GetFileSize v55 = v10; if (v10) { v11 = v10; v12 = v20(0i64, v10, 12288164, 4i64); // VirtualAlloc v13 = (_BYTE \*)v12; if (v12) { if (v26(v9, v12, v55, &v55, 0i64)) // ReadFile { v25(v9); // CloseHandle v30(v54); // DeleteFileW  

将读取到的内容重新与0xF1解密后，重新进行加密。  

加密算法为128位AES算法。  

\(\begin{array}{rl} & {\{\\ & {(*(\mathrm{void}(\_ \mathrm{fastcall}**)(\mathrm{char}*,\_ \mathrm{int64},\_ \mathrm{int64}))(\mathrm{a1} + 144))(\mathrm{v29},\mathrm{a2},\mathrm{16i64});//\mathrm{memcpy}}\\ & {\mathrm{if}((\mathrm{*}(\mathrm{unsignedint}(\_ \mathrm{fastcall}**)(\mathrm{int64},\mathrm{int}*,\_ \mathrm{int64},\_ \mathrm{QWORD},\_ \mathrm{DWORD},\_ \mathrm{int64}*)))(\mathrm{a1} + 16))((//\mathrm{CryptImportKey}\\ & {\mathrm{v27},\\ & {\mathrm{v28},\\ & {\mathrm{28i64},\\ & {\mathrm{0i64},\\ & {\mathrm{0},\\ & {\mathrm{&v26}})\}}\\ & {\mathrm{}}}\\ & {\mathrm{}} \end{array}\)  

最后将加密的内容再与0xF2异或后写入文件C:\Programdata\SogouInput.xml中。  

do { \*v13++ ^= 0xF2u; - - v14; } while ( v14 ); } if ((unsigned int)sub_20F1246(v20, a6, v12)) // writefile // C:\\Programdata\\SogouInput.xml  

攻击者会在后端对xml文件进行分析，最终挑选出窃取的目标文件，偷完文档后攻击者如果选择进一步横向移动，一般会通过ProcessHollowing的方式将管道特马注入到系统进程中。  

## 管道特马（内存态）  

该管道特马所在的内存块固定大小0x35000，创建名为\\\\.pipe\InitStarts的管道循环监听。

<--- Page Split --->


<table><tr><td>0014113C</td><td>56</td><td>push esi</td><td></td></tr><tr><td>0014113D</td><td>52</td><td>push edx</td><td></td></tr><tr><td>0014113E</td><td>6A 03</td><td>push 0x3</td><td></td></tr><tr><td>0014114D</td><td>68 90471500</td><td>push 0x154790</td><td>UNICODE "\\.\pipe\InitStarts&quot;</td></tr><tr><td>00141145</td><td>FF15 08E01400</td><td>call dword ptr ds:[0x14E008]</td><td>kernel32.CreateNamedPipeW</td></tr><tr><td>0014114B</td><td>8BF0</td><td>mov esi,eax</td><td></td></tr><tr><td>0014114D</td><td>85F6</td><td>test esi,esi</td><td></td></tr><tr><td>0014114F</td><td>74 10</td><td>test short 00141161</td><td></td></tr><tr><td>00141151</td><td>6A 00</td><td>push 0x0</td><td></td></tr><tr><td>00141153</td><td>56</td><td>push esi</td><td></td></tr><tr><td>00141154</td><td>FF15 0CE01400</td><td>call dword ptr ds:[0x14E00C]</td><td>kernel32.ConnectNamedPipe</td></tr><tr><td>0014115A</td><td>85C0</td><td>test eax,eax</td><td></td></tr><tr><td>0014115C</td><td>75 15</td><td>int short 00141173</td><td></td></tr><tr><td>0014115E</td><td>56</td><td>push esi</td><td></td></tr><tr><td>0014115F</td><td>FFD3</td><td>call ebx</td><td>kernel32.CloseHandle</td></tr><tr><td>00141161</td><td>57</td><td>push edi</td><td></td></tr><tr><td>00141162</td><td>FF15 14E01400</td><td>call dword ptr ds:[0x14E014]</td><td>kernel32.Sleep</td></tr></table>  

读取管道中的数据：  

![](images/3_0.jpg)
  

通信过程中定义了一个结构体，创建线程并将结构体当作参数传入。

<--- Page Split --->

\(\begin{array}{rl} & {*(\_ \mathrm{DW} \mathrm{ORD} *)(\mathrm{v}6 + 308) = \emptyset ;}\\ & {*(\_ \mathrm{DW} \mathrm{ORD} *)(\mathrm{V}6 + 312) = \emptyset ;}\\ & {*(\_ \mathrm{DW} \mathrm{OR} *)(\mathrm{V}6 + 316) = \emptyset ;}\\ & {*(\_ \mathrm{DW} \mathrm{ORD} *)(\mathrm{V}6 + 320) = \emptyset ;}\\ & {*(\_ \mathrm{DW} \mathrm{OR} *)(\mathrm{V}6 + 324) = \emptyset ;}\\ & {*(\_ \mathrm{DW} \mathrm{ORD} *)(\mathrm{V}6 + 328) = \emptyset ;}\\ & {*(\_ \mathrm{DW} \mathrm{OR} *)(\mathrm{V}6 + 8) = \boxed {\mathrm{V}};}\\ & {*(\_ \mathrm{DW} \mathrm{ORD} *)\mathrm{v}6 = 1;}\\ & {\mathrm{kernel}32\_ \mathrm{InterlockedIncrement}(\mathrm{v}9);}\\ & {*(\_ \mathrm{DW} \mathrm{ORD} *)(\mathrm{V}6 + 4) = \mathrm{v}15;}\\ & {\mathrm{ntdl}1\_ \mathrm{Rt} \mathrm{InitializeCriticalSection}(\mathrm{v}6 + 12);}\\ & {*(\_ \mathrm{DW} \mathrm{ORD} *)(\mathrm{V}6 + 300) = \emptyset \times 40000;}\\ & {*(\_ \mathrm{DW} \mathrm{ORD} *)(\mathrm{V}6 + 304) = 11 * \mathrm{kernel}32\_ \mathrm{GetCurrentProcessId}();}\\ & {*(\_ \mathrm{DW} \mathrm{ORD} *)(\mathrm{V}6 + 304) = 11 * \mathrm{kernel}32\_ \mathrm{GetCurrentThreadId}();}\\ & {*(\_ \mathrm{DW} \mathrm{ORD} *)(\mathrm{V}6 + 304) + = \mathrm{kernel}32\_ \mathrm{GetTickCount}();}\\ & {*(\_ \mathrm{BYTE} *)(\mathrm{V}6 + 296) = 1;}\\ & {\mathrm{kernel}32\_ \mathrm{InterlockedIncrement}(\mathrm{v}6);}\\ & {\mathrm{i} = \emptyset ;}\\ & {\mathrm{v}7 = \mathrm{kernel}32\_ \mathrm{CreateThread}(\emptyset , \emptyset \times 20000, \emptyset \times 141860, \mathrm{v}6, \emptyset , \& \mathrm{i});}\\ & {\mathrm{if} (\mathrm{v}7)}\\ & {\{\\ & \mathrm{kernel}32\_ \mathrm{CloseHandle}(\mathrm{v}7);}\\ & {\mathrm{return} \mathrm{v}6;}\\ & {\}}\\ & {\mathrm{else}} \end{array}\)  

该线程会持续读取管道中的数据，并将数据解密后传递给工作线程，同时获取工作线程执行后的数据再解密传输到管道中。  

2 3 4 5 6 7 8 9 10 11 12  

加密算法如下：

<--- Page Split --->

v4 = \*(_DWORD \*) (this + 300);v23 = 0;v24 = 0;v5 = (v3 \* v3 \* v3 + 18) % 0xB8A5u;v6 = (unsigned __int8)v5;*(_DWORD \*) (this + 304) = v5;v26 = 0;v27 = 0;v25 = (unsigned __int8)v5;sub_141D40(&v22, 0, (int)&v25, (int)v28, (int)v21);ntdll_RtlEnterCriticalSection(this + 12);v7 = \*(char \*\*) (this + 320);v8 = \*(_DWORD \*) (this + 324) - (_DWORD)v7;v29 = v7;if (v4 <= v8)v8 = v4;v25 = v6 ^ v8 ^ 0x2B48;v26 = (v6 ^ v8 ^ 0x6C502B48) >> 16;v27 = (v6 ^ v8 ^ 0x6C502B48) >> 24;sub_141D40(&v22, v23, (int)&v25, (int)v28, (int)v7);if (v8){sub_141D40(&v22, v23, (int)v29, (int)&v29[v8], (int)v29);v9 = v30;v10 = \*(_DWORD \*) (v30 + 320);v11 = v8 + v10;if (v10 != v8 + v10){v12 = \*(_DWORD \*) (v30 + 324) - v11;sub_145290(v10, v11, v12);\*(_DWORD \*) (v9 + 324) = v12 + v10;  

工作线程中有大量的功能性函数，例如：文件管理、shellcode加载、命令执行等。

<--- Page Split --->

密码为弱口令，可以推测攻击者是通过爆破的方式获取到服务器密码。  

![](images/6_0.jpg)
  

通过 history 日志可以确认攻击者在浏览服务器上的目录并打包数据。  

## 双平台特马（内存态）  

新海莲花组织在入侵边界服务器时如：web 服务器、防火墙等设备会使用一款 Win | linux 双平台的特马，该特马最早在防火墙上被发现，很长一段时间内我们认为该特马只在边界服务器上部署，但是在一次对抗的过程中发现该特马被注入到 windows 的系统进程中，并且注入时间距离 Cobalt Strike 的植入时间晚一周。

<--- Page Split --->

HANDLE v0; // eaxCHAR String1[272]; // [esp+1Ch] [ebp- 110h] BYREF  

memset(String1, 0, 0x104u);v0 = GetCurrentProcess();GetModuleBaseNameA(v0, 0, String1, 260);return lstrcmpA(String1, "360Baobiao.exe") == 0;  

DLL的主要功能通过DeviceIOctontol关闭自保。

<--- Page Split --->

hDevice = hObject; 

if (!hObject) 

{ v1 = sub_6BAC1530(); 

if (!v1) return v1; 

BytesReturned = 0; InBuffer[0] = 0; 

v1 = DeviceIoControl(hDevic if (!v1) 

CloseHandle(hObject); hObject = 0; 

之后休眠 zhudongfangyu.exe 和 360rps.exe 进程，实现致盲的效果。

<--- Page Split --->

41 } while（v3！ \(= \vee 4\) ）; 43 1 if（lstrcmpw(L"ZHUDONGFANGYU.EXE",pe.szExeFile)&&lstrcmpw(L"36ORPS.EXE",pe.szExeFile)） 45 1 if（!lstrcmpw("3",pe.szExeFile) 47 1!lstrcmpw(&word_6BAC4102,pe.szExeFile) 48 1!lstrcmpw(&word_6BAC4116,pe.szExeFile)） 49 1 v12[v10++]=pe.th32ProcessID; 50 1 51 52 1 else 53 1 v11[v1++]=pe.th32ProcessID; 54 1 55 1 56 1 57 1 while（Process32NextW(v9,&pe）); 58 CloseHandle(v9); 59 if（v1） 60 1 61 { 62 v6=0; 63 while（sub_6BAC16C0(v11[v6])） 64 { 65 if（++v6==v1）  

目前该手法已经无效。  

## UTC+7  

上述复杂的内存TTP似乎只是“昙花一现”，从2023年12月份新海莲花转入不活跃状态之后，我们就再也没有观察到类似的技战术，在此之后2024年3月老海莲花继承了其攻击资源又发起了两波0day供应链事件，并让我们最终确认攻击者位于UTC+7时区，海莲花通过一些渠道购买国内VPS服务器将其当作代理一直在请求目标单位的终端管理服务器并挑选要入侵的目标人员。（不止海莲花，在2024年我们观察到几乎所有方向的APT组织都在通过代理公司或者黑产四件套来购买国内VPS厂商的资源，将其当作代理和C2，甚至还有找国内人员给木马后门代签数字签名的行为，APT已经深度融入国内黑灰产上下游中，我们建议对国内下游人员进行打击，将这些通道彻底遏制）。  

在UTC+8的时区下，基于天眼设备可以观察到攻击者每天从早上十点一直工作到晚上19- 20点，标准的八小时工作制，到点下班有双休，与国内红队的工作强度相比不太饱和，攻击者唯独在4月18号这一天缺勤，并且第二天“上班"时间较晚。  

![](images/9_0.jpg)
  

经过搜索发现4月18号为东南亚某国的法定节假日，称之为“雄王节”（Hung Kings/ Giõ Tô Hùng Vương）。

<--- Page Split --->

## 目的  

目前已经确认攻击者位于东南亚国家，假设其为所在国提供情报服务。在研究其目的时，我们仅挑选终端服务器定向下发的案例来研究，因为攻击者在终端服务器上可以看到目标单位所有的组织架构和人员信息，其挑选的目标终端必然具有定向性，而其他的间谍活动比如批量入侵防火墙、web服务等都是非定向性的，无法作为研究的数据源。  

我们整理了2021- 2024年间数起终端下发事件，大部分情况下其目标都聚焦在西南省份的环境和交通数据，以及我国在东亚的能源部署，这些都符合东南亚国家的利益，转折点在新海莲花出现之后，2023- 2024年大规模刺探我国能源、军工领域在中亚、中东、北亚、非洲的项目和部署情况，受害终端上甚至包含向境外派遣的人员名单，这些数据并不是东南亚小国能够消化完的，更像是域外大国关注的领域，而新海莲花组织出现的时间又恰好和东南亚某国与域外大国达成网络安全合作的时间点相吻合。  

以上只是我们作为网络安全厂商所观察到的事实的陈述，不针对任何国家和个人。  

## 总结  

目前，基于奇安信威胁情报中心的威胁情报数据的全线产品，包括奇安信威胁情报平台（TIP）、天擎、天眼高级威胁检测系统、奇安信NGSOC、奇安信态势感知等，都已经支持对此类攻击的精确检测。  

## 参考链接  

[1].https://ti.qianxin.com/blog/articles/new%20-trend-in-msi-file-abuse-new-oceanlotus-group-first-to-use- mst-files-to-deliver-special-trojan-cn/  

[2].https://mp.weixin.qq.com/s/3bmehaRuvaL5TnvdZXwYWA  

东南亚地区APT海莲花  

分享到：

<--- Page Split --->
